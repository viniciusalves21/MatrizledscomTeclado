#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "pico/stdlib.h"
#include "hardware/pio.h"
#include "hardware/clocks.h"
#include "pico/bootrom.h"

// Arquivo com o programa PIO que controla os LEDs WS2812:
#include "pio_matrix.pio.h"

#define NUM_PIXELS 25   // 5x5
#define NUM_FRAMES 5    // mínimo de 5 frames
#define OUT_PIN    7    // Pino de saída de dados para os LEDs WS2812

static const char KEYPAD[4][4] = {
    {'1', '2', '3', 'A'},
    {'4', '5', '6', 'B'},
    {'7', '8', '9', 'C'},
    {'*', '0', '#', 'D'}
};
static const uint ROW_PINS[4] = {8, 9, 6, 5};   // Ajuste conforme seu hardware
static const uint COL_PINS[4] = {4, 3, 2, 28};  // Ajuste conforme seu hardware
static const uint32_t COR[5] = {0x00000000, 0x0000FF00, 0x00CC0000, 0x80000000, 0x33333300};
static const uint8_t FPS[10] = {10, 10, 8, 8, 8, 9, 10, 10, 10, 10};

static uint32_t animacao[10][NUM_FRAMES][NUM_PIXELS] = {
    //Animação 0 -------------------------------------------------OK
    {{0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000,
      0x00000000, 0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000,
      0x00000000, 0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000, 0x00000000,
      0x0000FF00, 0x0000FF00, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}
    },
    //Animação 1 -------------------------------------------------OK
    {{0x00FF0000, 0x00000000, 0x00000000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00000000, 0x00000000, 0x00FF0000},

     {0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000},

     {0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00FF0000, 0x00FF0000, 0x00FF0000, 0x00FF0000, 0x00FF0000,
      0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000},

     {0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000},

     {0x00FF0000, 0x00000000, 0x00000000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00FF0000, 0x00000000, 0x00000000, 0x00000000, 0x00FF0000}
    },
    //Animação 2 -------------------------------------------------OK
    {{0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0x00000000, 0xFF000000, 0x00000000, 0xFF000000, 0x00000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0xFF000000, 0x00000000, 0xFF000000, 0x00000000, 0xFF000000,
      0x00000000, 0xFF000000, 0xFF000000, 0xFF000000, 0x00000000,
      0xFF000000, 0x00000000, 0xFF000000, 0x00000000, 0xFF000000,
      0x00000000, 0xFF000000, 0xFF000000, 0xFF000000, 0x00000000,
      0xFF000000, 0x00000000, 0xFF000000, 0x00000000, 0xFF000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0xFF000000, 0x00000000, 0x00000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0x00000000, 0x00000000, 0xFF000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0x00000000, 0x00000000, 0xFF000000, 0x00000000, 0x00000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
      0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000}
    },
    //Animação 3 -------------------------------------------------OK
    {{0x804DFF00, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x804DFF00, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x804DFF00, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x804DFF00,
      0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00},

     {0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00,
      0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00,
      0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00},

     {0x00000000, 0x00000000, 0x804DFF00, 0x00000000, 0x00000000,
      0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00,
      0x00000000, 0x00000000, 0x804DFF00, 0x00000000, 0x00000000,
      0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00, 0x804DFF00,
      0x00000000, 0x00000000, 0x804DFF00, 0x00000000, 0x00000000},

     {0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00,
      0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00,
      0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000},

     {0x804DFF00, 0x00000000, 0x00000000, 0x00000000, 0x804DFF00,
      0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x00000000, 0x00000000, 0x804DFF00, 0x00000000, 0x00000000,
      0x00000000, 0x804DFF00, 0x00000000, 0x804DFF00, 0x00000000,
      0x804DFF00, 0x00000000, 0x00000000, 0x00000000, 0x804DFF00}
    },
    //Animação 4 -------------------------------------------------OK
    {{0x00000000, 0x00000000, 0x80800000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x80800000, 0x80800000, 0x00000000,
      0x00000000, 0x80800000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x80800000, 0x80800000, 0x80800000, 0x00000000},

     {0x80800000, 0x80800000, 0x80800000, 0x80800000, 0x80800000,
      0x80800000, 0x00000000, 0x00000000, 0x00000000, 0x80800000,
      0x80800000, 0x00000000, 0x80800000, 0x00000000, 0x80800000,
      0x80800000, 0x00000000, 0x00000000, 0x00000000, 0x80800000,
      0x80800000, 0x80800000, 0x80800000, 0x80800000, 0x80800000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x80800000, 0x80800000, 0x80800000, 0x00000000,
      0x00000000, 0x80800000, 0x00000000, 0x80800000, 0x00000000,
      0x00000000, 0x80800000, 0x80800000, 0x80800000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x80800000, 0x00000000, 0x00000000,
      0x00000000, 0x80800000, 0x80800000, 0x80800000, 0x00000000,
      0x00000000, 0x00000000, 0x80800000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x80800000, 0x00000000, 0x00000000, 0x00000000, 0x80800000,
      0x00000000, 0x80800000, 0x00000000, 0x80800000, 0x00000000,
      0x00000000, 0x00000000, 0x80800000, 0x00000000, 0x00000000,
      0x00000000, 0x80800000, 0x00000000, 0x80800000, 0x00000000,
      0x80800000, 0x00000000, 0x00000000, 0x00000000, 0x80800000}
    },
    //Animação 5 -------------------------------------------------OK
    {{0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000},

     {0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000,
      0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000, 0x99E60000}
    },
    //Animação 6 -------------------------------------------------OK
    {{0x00808000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00808000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00808000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00808000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00808000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00808000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00808000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00808000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00808000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00808000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00808000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00808000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00808000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00808000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00808000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00808000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00808000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00808000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00808000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00808000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00808000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00808000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00808000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00808000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00808000}
    },
    //Animação 7 -------------------------------------------------
    {{0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00400000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00FF0000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00100000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00200000, 0x00000000,
      0x00000000, 0x00400000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00FF0000, 0x00000000},

     {0x00000000, 0x00000000, 0x00FF0000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00400000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00200000, 0x00000000,
      0x00000000, 0x00100000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00100000, 0x00000000},

     {0x00000000, 0x00000000, 0x00200000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00400000, 0x00000000, 0x00000000,
      0x00000000, 0x00FF0000, 0x00000000, 0x00100000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00100000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00200000, 0x00000000, 0x00FF0000,
      0x00000000, 0x00400000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}
    },
    //Animação 8 -------------------------------------------------
    {{0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}
    },
    //Animação 9 -------------------------------------------------
    {{0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000},

     {0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
      0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}
    },
};

void init_keypad_pins();
char readKeypad();
void ligaLedsCor(PIO pio, uint sm, uint32_t cor);
void reproduzAnimacao(PIO pio, uint sm, uint32_t *anima, uint8_t fps);

int main() {
    stdio_init_all();
    init_keypad_pins();

    // Inicializa a PIO e o state machine
    PIO pio = pio0;
    uint sm = pio_claim_unused_sm(pio, true);
    uint offset = pio_add_program(pio, &pio_matrix_program);
    pio_matrix_program_init(pio, sm, offset, OUT_PIN);

    printf("Sistema iniciado. Aguardando teclas...\n");

    while (true) {
        char key = readKeypad();

        if (key != 0) {
            printf("Tecla pressionada: %c\n", key);

            if(key >= '0' && key <= '7')
                reproduzAnimacao(pio, sm, animacao[key - 48][0], FPS[key - 48]);
            else if(key >= '8' && key <= '9') {
                ligaLedsCor(pio, sm, 0);
                printf("Animação %c não definida: Desligando LEDs.\n", key);
            }
            else if(key >= 'A' && key <= 'D')
                ligaLedsCor(pio, sm, COR[key - 65]);
            else if(key == '#')
                ligaLedsCor(pio, sm, COR[key - 31]);

            while (readKeypad() != 0)
                tight_loop_contents();
        }
        sleep_ms(50);
    }
    return 0;
}

void init_keypad_pins()
{
    for (int i = 0; i < 4; i++) {
        gpio_init(ROW_PINS[i]);
        gpio_set_dir(ROW_PINS[i], GPIO_IN);
        gpio_pull_down(ROW_PINS[i]);
    }
    for (int i = 0; i < 4; i++) {
        gpio_init(COL_PINS[i]);
        gpio_set_dir(COL_PINS[i], GPIO_OUT);
        gpio_put(COL_PINS[i], 0);
    }
}

char readKeypad()
{
    for (int col = 0; col < 4; col++) {
        // Ativa coluna
        gpio_put(COL_PINS[col], 1);

        for (int row = 0; row < 4; row++) {
            if (gpio_get(ROW_PINS[row])) {
                sleep_ms(10); // debounce simples
                if (gpio_get(ROW_PINS[row])) {
                    // Desativa coluna antes de retornar
                    gpio_put(COL_PINS[col], 0);
                    return KEYPAD[row][col];
                }
            }
        }
        // Desativa coluna antes de continuar
        gpio_put(COL_PINS[col], 0);
    }
    return 0;
}

void ligaLedsCor(PIO pio, uint sm, uint32_t cor)
{
    for (int i = 0; i < NUM_PIXELS; i++)
        pio_sm_put_blocking(pio, sm, cor);
}

void reproduzAnimacao(PIO pio, uint sm, uint32_t *anima, uint8_t fps)
{
    int delay_ms = 1000 / fps;
    for(int16_t frame = 0; frame < NUM_FRAMES; frame++, anima += NUM_PIXELS)
    {
        for (int16_t i = 0; i < NUM_PIXELS; i++)
            pio_sm_put_blocking(pio, sm, *(anima + i));
        sleep_ms(delay_ms);
    }
}
